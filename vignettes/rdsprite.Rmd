---
output: html_document
---

```{r}
library(dplyr)
library(ggplot2)
library(tidyr)
library(data.table)
library(Matrix)
library(ggthemes)
library(dcon)
```

```{r}
windows <- fread('/rafalab/lzou/rdsprite/dna_matrix/mm10.100kb.windows', header=F, col.names=c('chrom','start','end'))
windows$idx <- seq(1,nrow(windows))
l1 <- readMM('/rafalab/lzou/rdsprite/dna_matrix/L1,LINE|LINE,L1_DNA_matrix_count_RNA_100000_clusters_2-100.mtx')
l1md <- readMM('/rafalab/lzou/rdsprite/dna_matrix/L1Md_DNA_matrix_count_RNA_100000_clusters_2-100.mtx')
b1 <- readMM('/rafalab/lzou/rdsprite/dna_matrix/Alu,SINE|SINE,Alu_DNA_matrix_count_RNA_100000_clusters_2-100.mtx')
total <- readMM('/rafalab/lzou/rdsprite/dna_matrix/All_DNA_matrix_count_RNA_100000_clusters_2-100.mtx')
total_DNA <- readMM('/rafalab/lzou/rdsprite/total_DD_DNA_matrix_100000_clusters_2-100.mtx')
compartments <- fread('/rafalab/lzou/rdsprite/mm10_mESC_bonev2017_tableS2.csv')
```

```{r}
l1_chr18 <- l1[windows$idx[windows$chrom=='chr18'],windows$idx[windows$chrom=='chr18']]
l1md_chr18 <- l1md[windows$idx[windows$chrom=='chr18'],windows$idx[windows$chrom=='chr18']]
b1_chr18 <- b1[windows$idx[windows$chrom=='chr18'],windows$idx[windows$chrom=='chr18']]
total_chr18 <- total[windows$idx[windows$chrom=='chr18'],windows$idx[windows$chrom=='chr18']]
total_DNA_chr18 <- as(total_DNA[windows$idx[windows$chrom=='chr18'],windows$idx[windows$chrom=='chr18']], 'dgCMatrix')

# get a basic observed/expected for chr18
dd <- summary(total_DNA_chr18) %>%
  mutate(dist = j-i)

expec <- dd %>%
  group_by(dist) %>%
  summarise(expected = mean(x))

dd <- dd %>%
  left_join(expec, by = 'dist') %>%
  mutate(OE = x/expected)

OE_mat <- sparseMatrix(i=dd$i, j= dd$j, x = dd$OE, dims=c(908,908))

save(l1_chr18, l1md_chr18, b1_chr18, total_chr18, total_DNA_chr18, OE_mat, file = '/rafalab/lzou/dcon/hiplastic/shiny_data_v2.RData')
```





# Visualizing total DNA-DNA contact matrix for DNA contacting RNA

```{r}
summary(total_chr18) %>%
  ggplot(aes(x = j, y = i)) +
  geom_raster(aes(fill=x)) +
  scale_y_reverse() +
  scale_fill_gradient(low = 'white', high='blue') +
  theme_classic()
```



# L1 DNA-DNA contact matrix


```{r}
summary(l1_chr18) %>%
  dplyr::rename(l1 = x) %>%
  left_join(summary(total_chr18) %>% dplyr::rename(total = x)) %>%
  ggplot(aes(x = j, y = i)) +
  geom_raster(aes(fill=l1)) +
  scale_y_reverse() +
  scale_fill_gradient(low = 'white', high='blue') +
  theme_classic()
```


# L1 DNA-DNA contact matrix divided by total count

```{r}
summary(l1_chr18) %>%
  dplyr::rename(l1 = x) %>%
  left_join(summary(total_chr18) %>% dplyr::rename(total = x)) %>%
  ggplot(aes(x = j, y = i)) +
  geom_raster(aes(fill=l1/total)) +
  scale_y_reverse() +
  scale_fill_gradient(low = 'white', high='blue') +
  theme_classic()
```


# B1 DNA-DNA contact matrix

```{r}
summary(b1_chr18) %>%
  ggplot(aes(x = j, y = i)) +
  geom_raster(aes(fill=x)) +
  scale_y_reverse() +
  scale_fill_gradient(low = 'white', high='red') +
  theme_classic()
```


# B1 DNA-DNA contact matrix divided by total count


```{r}
summary(b1_chr18) %>%
  dplyr::rename(b1 = x) %>%
  left_join(summary(total_chr18) %>% dplyr::rename(total = x)) %>%
  ggplot(aes(x = j, y = i)) +
  geom_raster(aes(fill=b1/total)) +
  scale_y_reverse() +
  scale_fill_gradient(low = 'white', high='red') +
  theme_classic()
```


# Fraction L1 and fraction B1 plotted against each other


```{r}
summary(t(b1_chr18)) %>%
  mutate(x = -x) %>%
  bind_rows(summary(l1_chr18)) %>%
  left_join(summary(total_chr18) %>% dplyr::rename(total = x) %>% bind_rows(summary(t(total_chr18)) %>% dplyr::rename(total=x))) %>%
  ggplot(aes(x = j*1e5/1e6, y = i*1e5/1e6)) +
  geom_raster(aes(fill=x/total)) +
  scale_y_reverse() +
  scale_fill_gradient2(low = 'red', mid = 'white', high='blue', midpoint=0) +
  geom_segment(data = compartments %>% filter(chrom=='chr18') %>% mutate(start=start/1e6, end=end/1e6),
               aes(x = 0, xend = 0, y = start, yend = end, color = Compartment), size=5) +
  scale_color_tableau(direction=-1) +
  theme_classic()
```


# Fraction L1 - fraction B1 


```{r}
summary(b1_chr18) %>%
  dplyr::rename(b1 = x) %>%
  full_join(summary(l1_chr18) %>% dplyr::rename(l1 = x)) %>%
  replace_na(list(b1=0, l1=0)) %>%
  left_join(summary(total_chr18) %>% dplyr::rename(total = x)) %>%
  ggplot(aes(x = j, y = i)) +
  geom_raster(aes(fill=(l1/total)-(b1/total))) +
  scale_y_reverse() +
  scale_fill_gradient2(low = 'red', mid = 'white', high='blue', midpoint=0) +
  theme_classic()
```

# Zoomed in on a bright B1 spot with compartment annotation


```{r}
dd <- summary(b1_chr18) %>%
  dplyr::rename(b1 = x) %>%
  full_join(summary(l1_chr18) %>% dplyr::rename(l1 = x)) %>%
  replace_na(list(b1=0, l1=0)) %>%
  left_join(summary(total_chr18) %>% dplyr::rename(total = x)) %>%
  filter(i >= 150, i <= 450, j >= 150, j <= 450) 

dd <- dd %>% bind_rows(data.frame(j=dd$i, i = dd$j, b1 = dd$b1, l1=dd$l1, total=dd$total))

dd %>%
  ggplot(aes(x = j*100000/1e6, y = i*100000/1e6)) +
  geom_raster(aes(fill=(l1/total)-(b1/total))) +
  scale_y_reverse() +
  scale_fill_gradient2(low = 'red', mid = 'white', high='blue', midpoint=0) +
  geom_segment(data = compartments %>% filter(chrom=='chr18') %>% mutate(start=start/1e6, end=end/1e6) %>%
                 filter(start >= 125*1e5/1e6, end <= 450*1e5/1e6),
               aes(x = 47, xend = 47, y = start, yend = end, color = Compartment), size=5) +
  geom_segment(data = compartments %>% filter(chrom=='chr18') %>% mutate(start=start/1e6, end=end/1e6) %>%
                 filter(start >= 125*1e5/1e6, end <= 450*1e5/1e6),
               aes(x = start, xend = end, y = 47, yend = 47, color = Compartment), size=5) +
  scale_color_tableau(direction=-1) +
  theme_classic()
```

```{r}
dd %>%
  filter(total>=10) %>%
  ggplot(aes(x = j*100000/1e6, y = i*100000/1e6)) +
  geom_raster(aes(fill=(l1/total)-(b1/total))) +
  scale_y_reverse() +
  scale_fill_gradient2(low = 'red', mid = 'white', high='blue', midpoint=0) +
  geom_segment(data = compartments %>% filter(chrom=='chr18') %>% mutate(start=start/1e6, end=end/1e6) %>%
                 filter(start >= 125*1e5/1e6, end <= 450*1e5/1e6),
               aes(x = 47, xend = 47, y = start, yend = end, color = Compartment), size=5) +
  geom_segment(data = compartments %>% filter(chrom=='chr18') %>% mutate(start=start/1e6, end=end/1e6) %>%
                 filter(start >= 125*1e5/1e6, end <= 450*1e5/1e6),
               aes(x = start, xend = end, y = 47, yend = 47, color = Compartment), size=5) +
  scale_color_tableau(direction=-1) +
  theme_classic()
```


```{r}
dd %>%
  mutate(i = i*1e5/1e6, j = j*1e5/1e6) %>%
  filter(i >=32, i<=40, j >= 20, j <= 28) %>%
  filter(total >= 5) %>%
  ggplot(aes(x = j, y = i)) +
  geom_raster(aes(fill=(l1/total)-(b1/total))) +
  scale_y_reverse() +
  scale_fill_gradient2(low = 'red', mid = 'white', high='blue', midpoint=0) +
  # geom_segment(data = compartments %>% filter(chrom=='chr18') %>% mutate(start=start/1e6, end=end/1e6) %>%
  #                filter(start >= 125*1e5/1e6, end <= 450*1e5/1e6),
  #           aes(x = 47, xend = 47, y = start, yend = end, color = Compartment), size=5) +
  # geom_segment(data = compartments %>% filter(chrom=='chr18') %>% mutate(start=start/1e6, end=end/1e6) %>%
  #                filter(start >= 125*1e5/1e6, end <= 450*1e5/1e6),
  #           aes(x = start, xend = end, y = 47, yend = 47, color = Compartment), size=5) +
  scale_color_tableau(direction=-1) +
  theme_classic()
```


# Attempt to deconvolve B1 and L1 separately for this window


```{r}
# B1 matrix
m <- dd %>%
  filter(i*1e5/1e6 >=32, i*1e5/1e6<=40, j*1e5/1e6 >= 20, j*1e5/1e6 <= 28)  %>%
  dplyr::select(i,j,b1) %>%
  pivot_wider(id_cols = i, names_from=j, values_from = b1, values_fill=0)
rownames(m) <- m$i
m$i <- NULL
m <- Matrix(as.matrix(m))

# total DNA matrix, site i
Di <- dd %>%
  filter(i*1e5/1e6 >=32, i*1e5/1e6<=40, j*1e5/1e6 >= 32, j*1e5/1e6 <= 40)  %>%
  dplyr::select(i,j,total) %>%
  distinct() %>%
  pivot_wider(names_from=j, values_from = total, values_fill=0)
rownames(Di) <- Di$i
Di$i <- NULL
Di <- as.matrix(Di)

# total DNA matrix, site j
Dj <- dd %>%
  filter(i*1e5/1e6 >=20, i*1e5/1e6<=28, j*1e5/1e6 >= 20, j*1e5/1e6 <= 28)  %>%
  dplyr::select(i,j,total) %>%
  distinct() %>%
  pivot_wider(id_cols = i, names_from=j, values_from = total, values_fill=0)
rownames(Dj) <- Dj$i
Dj$i <- NULL
Dj <- as.matrix(Dj)


myDcon <- Dcon(mat = list(m=m), hic = list(hic1=Di, hic2=Dj))
myDconvolved <- deconvolve(myDcon)


r1 <- rowSums(m)
r2 <- colSums(m)
hic1 <- dcon:::normalize_hic(Di, gamma=0.5)
hic2 <- dcon:::normalize_hic(Dj, gamma=0.5)
df=21
B <- dcon:::construct_basis(1:length(r1), df=df)
fit_r1 <- try(dcon:::fit_decon(r1, hic1, df))
fit_r2 <- try(dcon:::fit_decon(r2, hic2, df))
a1 <- fit_r1$a
a2 <- fit_r2$a
ff1 <- (B%*%a1)-log(sum(exp(B%*%a1)))
ff2 <- (B%*%a2)-log(sum(exp(B%*%a2)))
res <- exp(matrix(data = rep(ff1, df), nrow=length(ff1), ncol=length(ff1)) + 
             t(matrix(data = rep(ff2, df), nrow = length(ff2), ncol = length(ff2))))
```

```{r}
summary(m) %>%
  ggplot(aes(x = j, y = i)) +
  geom_raster(aes(fill=x)) +
  scale_y_reverse() +
  scale_fill_gradient_tableau() +
  theme_classic()
```


```{r}
b1_decon <- res
b1_decon %>%
  reshape2::melt() %>%
  ggplot(aes(x = Var2, y = Var1)) +
  geom_raster(aes(fill=value)) +
  scale_y_reverse() +
  scale_fill_gradient_tableau() +
  theme_classic()
```


```{r}
# L1 matrix
m <- dd %>%
  filter(i*1e5/1e6 >=32, i*1e5/1e6<=40, j*1e5/1e6 >= 20, j*1e5/1e6 <= 28)  %>%
  dplyr::select(i,j,l1) %>%
  pivot_wider(id_cols = i, names_from=j, values_from = l1, values_fill=0)
rownames(m) <- m$i
m$i <- NULL
m <- Matrix(as.matrix(m))

# total DNA matrix, site i
Di <- dd %>%
  filter(i*1e5/1e6 >=32, i*1e5/1e6<=40, j*1e5/1e6 >= 32, j*1e5/1e6 <= 40)  %>%
  dplyr::select(i,j,total) %>%
  distinct() %>%
  pivot_wider(names_from=j, values_from = total, values_fill=0)
rownames(Di) <- Di$i
Di$i <- NULL
Di <- as.matrix(Di)

# total DNA matrix, site j
Dj <- dd %>%
  filter(i*1e5/1e6 >=20, i*1e5/1e6<=28, j*1e5/1e6 >= 20, j*1e5/1e6 <= 28)  %>%
  dplyr::select(i,j,total) %>%
  distinct() %>%
  pivot_wider(id_cols = i, names_from=j, values_from = total, values_fill=0)
rownames(Dj) <- Dj$i
Dj$i <- NULL
Dj <- as.matrix(Dj)


myDcon <- Dcon(mat = list(m=m), hic = list(hic1=Di, hic2=Dj))
myDconvolved <- deconvolve(myDcon)


r1 <- rowSums(m)
r2 <- colSums(m)
hic1 <- dcon:::normalize_hic(Di, gamma=0.5)
hic2 <- dcon:::normalize_hic(Dj, gamma=0.5)
df=21
B <- dcon:::construct_basis(1:length(r1), df=df)
fit_r1 <- try(dcon:::fit_decon(r1, hic1, df))
fit_r2 <- try(dcon:::fit_decon(r2, hic2, df))
a1 <- fit_r1$a
a2 <- fit_r2$a
ff1 <- (B%*%a1)-log(sum(exp(B%*%a1)))
ff2 <- (B%*%a2)-log(sum(exp(B%*%a2)))
res <- exp(matrix(data = rep(ff1, df), nrow=length(ff1), ncol=length(ff1)) + 
             t(matrix(data = rep(ff2, df), nrow = length(ff2), ncol = length(ff2))))
```

```{r}
l1_decon <- res
l1_decon %>%
  reshape2::melt() %>%
  ggplot(aes(x = Var2, y = Var1)) +
  geom_raster(aes(fill=value)) +
  scale_y_reverse() +
  scale_fill_gradient_tableau() +
  theme_classic()
```


```{r}
(b1_decon-l1_decon) %>%
  reshape2::melt() %>%
  mutate(Var2 = Var2*(8/81)+20, Var1 = Var1*(8/81)+32) %>% 
  ggplot(aes(x = Var2, y = Var1)) +
  geom_raster(aes(fill=value)) +
  scale_x_continuous() +
  scale_y_reverse() +
  scale_fill_gradient2_tableau(palette='Orange-Blue-White Diverging', trans='reverse') +
  geom_segment(data = compartments %>% filter(chrom=='chr18') %>% mutate(start=start/1e6, end=end/1e6) %>%
                 filter(start >= 32, end <= 42),
               aes(x = 28.5, xend = 28.5, y = start, yend = end, color = Compartment), size=5) +
  geom_segment(data = compartments %>% filter(chrom=='chr18') %>% mutate(start=start/1e6, end=end/1e6) %>%
                 filter(start >= 18, end <= 31),
               aes(x = start, xend = end, y = 31.5, yend = 31.5, color = Compartment), size=5) +
  theme_classic() +
  ylab('chr18 position') +
  xlab('chr18 position')
```


# Put A/B compartment labels on the deconvolved image

```{r}

```


```{r}
summary(l1_chr18) %>%
  mutate(x = log2(x+1)) %>%
  bind_rows(summary(t(b1_chr18)) %>% mutate(x = -log2(x+1))) %>%
  ggplot(aes(x = j, y = i)) +
  geom_raster(aes(fill=x)) +
  scale_y_reverse() +
  scale_fill_gradient2(name='log2(count+1)',low = 'red', mid='white', high='blue', midpoint=0) +
  theme_classic() +
  ggtitle('raw data 100kb bins chr18 L1 (blue, top) and B1 (red, bottom)')
```


```{r}
summary(l1_chr18) %>%
  mutate(x = log2(x+1)) %>%
  bind_rows(summary(t(b1_chr18)) %>% mutate(x = -log2(x+1))) %>%
  filter(i >= 100, i <=400, j >= 100, j <= 400) %>%
  ggplot(aes(x = j, y = i)) +
  geom_raster(aes(fill=x)) +
  scale_y_reverse() +
  scale_fill_gradient2(name='log2(count+1)',low = 'red', mid='white', high='blue', midpoint=0) +
  theme_classic() +
  ggtitle('raw data 100kb bins chr18 L1 (blue, top) and B1 (red, bottom)')
```




```{r}
# plot ratio
summary(l1_chr18) %>%
  mutate(l1 = log2(x+1)) %>%
  full_join(summary((b1_chr18)) %>% mutate(b1 = log2(x+1))) %>%
  replace_na(list(l1=0, b1=0)) %>%
  ggplot(aes(x = j, y = i)) +
  geom_raster(aes(fill=l1-b1)) +
  scale_y_reverse() +
  scale_fill_gradient2(name='log2(L1/B1)',low = 'red', mid='white', high='blue', midpoint=0) +
  theme_classic() +
  ggtitle('raw data 100kb bins chr18 L1/B1 ratio')
```

```{r}
# plot ratio
summary(l1_chr18) %>%
  mutate(l1 = log2(x+1)) %>%
  full_join(summary((b1_chr18)) %>% mutate(b1 = log2(x+1))) %>%
  filter(i >= 100, i <=400, j >= 100, j <= 400) %>%
  replace_na(list(l1=0, b1=0)) %>%
  ggplot(aes(x = j, y = i)) +
  geom_raster(aes(fill=l1-b1)) +
  scale_y_reverse() +
  scale_fill_gradient2(name='log2(L1/B1)',low = 'red', mid='white', high='blue', midpoint=0) +
  theme_classic() +
  ggtitle('raw data 100kb bins chr18 L1/B1 ratio')
```



```{r}
as.matrix(l1_chr19[5500:5700,5500:5700]) %>%
  reshape2::melt() %>%
  mutate(type='L1') %>%
  bind_rows(as.matrix(b1_chr19[5500:5700,5500:5700]) %>% reshape2::melt() %>% mutate(type='B1') %>% mutate(value = -value)) %>%
  ggplot(aes(x = Var2, y = Var1)) +
  geom_raster(aes(fill=value)) +
  scale_y_reverse() +
  scale_fill_gradient2(low = 'red', mid='grey', high='blue', midpoint=0) +
  theme_classic()
```


```{r}
l1mdt <- readRDS('/rafalab/lzou/rdsprite/sparse_grid/L1Md_T_sparse_grid_1000_clusters_2-100_alleleFalse.rds')
l1mdt <- l1mdt[windows$idx[windows$chrom=='chrX'],windows$idx[windows$chrom=='chrX']]
```

```{r}

```

