---
output: html_document
---


# genome-wide scan of high L1Md RNA
# compare to adjacent



# column sums of rna production also associated with O/E?

L1 RNA production normalizing to L1 DNA density (stratify by L1 DNA on both sides)

e.g. look only at Low-Low, stratify by RNA production, and High-High similar

i.e. if you have 2 regions with equal-ish L1Md density but one has more 
RNA then does it interact more with other regions with higher L1Md RNA content


---

plot RNA pileup, how many large peaks are there across the genome


```{r setup}
library(dplyr)
library(ggplot2)
library(tidyr)
library(data.table)
library(Matrix)
library(dcon)

library(rtracklayer)
library(InteractionSet)
mychrom <- 'chr18'
```

```{r}
windows <- fread('/rafalab/lzou/rdsprite/dna_matrix/mm10.100kb.windows', header=F, col.names=c('chrom','start','end'))
windows$start <- windows$start+1
windows$idx <- seq(1,nrow(windows))
l1 <- readMM('/rafalab/lzou/rdsprite/dna_matrix/L1,LINE|LINE,L1_DNA_matrix_count_RNA_100000_clusters_2-100.mtx')
l1md <- readMM('/rafalab/lzou/rdsprite/dna_matrix/L1Md_DNA_matrix_count_RNA_100000_clusters_2-100.mtx')
b1 <- readMM('/rafalab/lzou/rdsprite/dna_matrix/Alu,SINE|SINE,Alu_DNA_matrix_count_RNA_100000_clusters_2-100.mtx')
total_DNA <- readMM('/rafalab/lzou/rdsprite/total_DNA_matrix_100000_clusters_2-100.mtx')
compartments <- fread('/rafalab/lzou/rdsprite/mm10_mESC_bonev2017_tableS2.csv')
l1_annot <- fread('/rafalab/lzou/resources/mm10.100kb.windows.L1.coverage',
                  col.names = c('chrom','start','end','nfeatures', 'nbp',
                                'tot', 'frac')) |>
  filter(chrom==mychrom)
l1md_annot <- fread('/rafalab/lzou/resources/mm10.100kb.windows.L1Md.coverage',
                    col.names = c('chrom','start','end','nfeatures', 'nbp',
                                  'tot', 'frac'))|>
  filter(chrom==mychrom)
b1_annot <- fread('/rafalab/lzou/resources/mm10.100kb.windows.B1.coverage',
                  col.names = c('chrom','start','end','nfeatures', 'nbp',
                                'tot', 'frac')) |>
  filter(chrom==mychrom)
```


```{r}
l1md_annot <- fread('/rafalab/lzou/resources/mm10.100kb.windows.L1Md.coverage',
                    col.names = c('chrom','start','end','nfeatures', 'nbp',
                                  'tot', 'frac'))
res <- NULL
for (i in paste0('chr',seq(1,19))) {
  message(i)
  total_DNA_chr <- as(total_DNA[windows$idx[windows$chrom==i],windows$idx[windows$chrom==i]], 'dgCMatrix')
  # get a basic observed/expected for chr18
  dd <- summary(total_DNA_chr) %>%
    mutate(dist = j-i)
  expec <- dd %>%
    group_by(dist) %>%
    summarise(expected = mean(x))
  dd <- dd %>%
    left_join(expec, by = 'dist') %>%
    mutate(OE = x/expected)
  OE_mat <- sparseMatrix(i=dd$i, j= dd$j, x = dd$OE, dims=c(length(which(windows$chrom==i)),length(which(windows$chrom==i))))
  OE_mat <- OE_mat + t(OE_mat) - diag(diag(OE_mat))
  l1md_sub <- l1md_annot |> filter(chrom==i)
  low <- which(l1md_sub$frac <= 0.02)
  med <- which(l1md_sub$frac > 0.02 & l1md_sub$frac <= 0.1)
  high <- which(l1md_sub$frac > 0.1)
  hh <- colMeans(OE_mat[high,])[high]
  hl <- colMeans(OE_mat[high,])[low]
  ll <- colMeans(OE_mat[low,])[low]
  df <- data.frame(x = c(hh, hl, ll), 
                   type = c(rep('hh', length(hh)),
                            rep('hl', length(hl)),
                            rep('ll', length(ll))),
                   chrom = i)
  if (is.null(res)) {
    res <- df
  } else {
    res <- bind_rows(res,df)
  }
}
```


```{r}
res |>
  ggplot(aes(x = x)) +
  geom_density(aes(fill = type), alpha=0.25)
```


```{r}
b1_annot <- fread('/rafalab/lzou/resources/mm10.100kb.windows.B1.coverage',
                    col.names = c('chrom','start','end','nfeatures', 'nbp',
                                  'tot', 'frac'))
res <- NULL
for (i in paste0('chr',seq(1,19))) {
  message(i)
  total_DNA_chr <- as(total_DNA[windows$idx[windows$chrom==i],windows$idx[windows$chrom==i]], 'dgCMatrix')
  # get a basic observed/expected for chr18
  dd <- summary(total_DNA_chr) %>%
    mutate(dist = j-i)
  expec <- dd %>%
    group_by(dist) %>%
    summarise(expected = mean(x))
  dd <- dd %>%
    left_join(expec, by = 'dist') %>%
    mutate(OE = x/expected)
  OE_mat <- sparseMatrix(i=dd$i, j= dd$j, x = dd$OE, dims=c(length(which(windows$chrom==i)),length(which(windows$chrom==i))))
  OE_mat <- OE_mat + t(OE_mat) - diag(diag(OE_mat))
  b1_sub <- b1_annot |> filter(chrom==i)
  low <- which(b1_sub$frac <= 0.02)
  med <- which(b1_sub$frac > 0.02 & b1_sub$frac <= 0.05)
  high <- which(b1_sub$frac > 0.05)
  hh <- colMeans(OE_mat[high,])[high]
  hl <- colMeans(OE_mat[high,])[low]
  ll <- colMeans(OE_mat[low,])[low]
  df <- data.frame(x = c(hh, hl, ll), 
                   type = c(rep('hh', length(hh)),
                            rep('hl', length(hl)),
                            rep('ll', length(ll))),
                   chrom = i)
  if (is.null(res)) {
    res <- df
  } else {
    res <- bind_rows(res,df)
  }
}
```


```{r}
res |>
  ggplot(aes(x = x)) +
  geom_density(aes(fill = type), alpha=0.25)
```
